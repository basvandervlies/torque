#!/usr/bin/make -f
# Made with the aid of debmake, by Christoph Lameter,
# based on the sample debian/rules file for GNU hello by Ian Jackson.
#
# Authors: Bas van der Vlies
# Desc.  : Builds a torque deb package from the sources
#
# SVN INFO:
#	$Id: rules 2385 2006-11-03 07:20:35Z bas $
#
#	compat=4

package=torque

patched: 
	$(checkdir)

	# Make scripts executable
	#
	chmod +x debian/patches/apply
	chmod +x debian/conf_torque

	# apply some patches
	debian/patches/apply

	touch patched

build: patched
	$(checkdir)
	debian/conf_torque
	$(MAKE)
	touch build

clean:
	$(checkdir)
	-rm -f build
	-$(MAKE) distclean
	-rm -f `find . -name "*~"`
	-rm -rf debian/torque debian/files* core
	-rm -f debian/*.debhelper

binary-indep: checkroot build
	$(checkdir)
# There are no architecture-independent files to be uploaded
# generated by this package.  If there were any they would be
# made here.

binary-arch: checkroot build
	$(checkdir)
	-rm -rf debian/torque
	install -d debian/torque
	cd debian/torque && install -d `cat ../dirs`

	chmod 700 buildutils/pbs_mkdirs
	DESTDIR=`pwd`/debian/torque buildutils/pbs_mkdirs\
		-v -C./src/tools/chk_tree -d `pwd`/debian/torque/var/spool/torque all

	$(MAKE) DESTDIR=`pwd`/debian/torque install

	  # OLD PBS stuff before 2.1.0
 	  #libdir=`pwd`/debian/torque/usr/lib/torque \
	  #includedir=`pwd`/debian/torque/usr/include/torque \
	  #PBS_SERVER_HOME=`pwd`/debian/torque/var/spool/torque \

	#debian/patch_gui_cmds.sh /usr/lib/torque

	dh_testdir
	dh_testroot 
	dh_installdirs
	dh_installchangelogs CHANGELOG
	#dh_installdocs -Xcontrib README.mpiexec
	dh_installdocs -Xcontrib
	dh_installexamples contrib/* -XCVS
	dh_install
	dh_link
	dh_installdebconf
	dh_compress
	dh_fixperms
	dh_installdeb 
	dh_makeshlibs --noscripts
	dh_shlibdeps
	dh_gencontrol 

	## Do not modify any postinst/rm scripts
	#
	dh_installinit --noscripts 

	dh_md5sums

	#chown -R root.root debian/torque
	#chmod -R go=rX debian/torque

	#
	# Include pbs_mkdirs in the package, else we have to make own
	# directories. Thanks to Jaap Dijkshoorn
	#
	cp buildutils/pbs_mkdirs debian/torque/usr/sbin

	# Not in the standard install ;-)
	#
	#cp src/include/rm.h debian/torque/usr/include/torque
	#cp src/include/log.h debian/torque/usr/include/torque

	dh_builddeb

define checkdir
	test -f debian/rules
endef

binary: binary-indep binary-arch

checkroot:
	$(checkdir)
	test root = "`whoami`"

.PHONY: binary binary-arch binary-indep clean checkroot
